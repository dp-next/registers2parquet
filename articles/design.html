<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Design • registers2parquet</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="design_files/libs/quarto-html/popper.min.js"></script><script src="design_files/libs/quarto-html/tippy.umd.min.js"></script><link href="design_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="design_files/libs/quarto-html/light-border.css" rel="stylesheet">
<script src="design_files/libs/quarto-diagram/mermaid.min.js"></script><script src="design_files/libs/quarto-diagram/mermaid-init.js"></script><link href="design_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Design">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">registers2parquet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/design.html">Design</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/dp-next/registers2parquet/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Design</h1>




      <small class="dont-index">Source: <a href="https://github.com/dp-next/registers2parquet/blob/main/vignettes/design.qmd" class="external-link"><code>vignettes/design.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="level2"><h2 id="core-functionality">Core functionality<a class="anchor" aria-label="anchor" href="#core-functionality"></a>
</h2>
<p>This is the list of the core functionality in the <code>registers2parquet</code> package:</p>
<ol type="1">
<li>Converts Danish register data from SAS files to the modern and efficient Parquet format.</li>
<li>Read register Parquet files into R as a DuckDB table.</li>
<li>Provides functions to list available SAS or Parquet register files directly from R.</li>
</ol></section><section class="level2"><h2 id="parallel-processing">Parallel processing<a class="anchor" aria-label="anchor" href="#parallel-processing"></a>
</h2>
<p>Each register-year pairing (including duplicate years) are sent to a separate process. That way, rather than converting 1000+ registers one after the other, it can be split into chunks based on the number of available CPU cores. For instance, if you set the number of “workers” (cores) to 4, than the 1000+ registers will be split into 4 groups and each group will be processed simultaneously on its own core.</p>
<p>There are some overheads to parallel processing, so it works best with a large number of files and when the files are also relatively large, or if the processing time per file is substantial.</p>
</section><section class="level2"><h2 id="visual-representation-of-data-flow">Visual representation of data flow<a class="anchor" aria-label="anchor" href="#visual-representation-of-data-flow"></a>
</h2>
<div class="cell" data-file="flow.mmd" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p>
<figure class=""><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    subgraph SAS [SAS Files]
        direction TB
        A1[bef2018.sas7bdat]
        A2[bef2019.sas7bdat]
        A3[bef2020.sas7bdat]
        A4[bef2021.sas7bdat]
        A5[bef2022.sas7bdat]
        A6[December_2023/bef2022.sas7bdat]
        A7[December_2023/bef2023.sas7bdat]
    end

    subgraph Parquet [Parquet Files]
        direction TB
        B1[bef/year=2018/part-0.parquet]
        B2[bef/year=2019/part-0.parquet]
        B3[bef/year=2020/part-0.parquet]
        B4[bef/year=2021/part-0.parquet]
        B5[bef/year=2022/part-0.parquet]
        B6[bef/year=2023/part-0.parquet]
    end

    F1[Data]
    F2[Data]
    F3[Data]
    F4[Data]
    F5[Data]
    F6[Data]

    A1 --&gt;|import| F1 --&gt;|export| B1
    A2 --&gt;|import| F2 --&gt;|export| B2
    A3 --&gt;|import| F3 --&gt;|export| B3
    A4 --&gt;|import| F4 --&gt;|export| B4
    A5 --&gt;|import &amp;&lt;br&gt;join| F5
    A6 --&gt;|import &amp;&lt;br&gt;join| F5
    F5 --&gt;|export| B5
    A7 --&gt;|import| F6 --&gt;|export| B6

    %% Styling
    style SAS fill:#FFFFFF, color:#000000
    style Parquet fill:#FFFFFF, color:#000000
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section><section class="level2"><h2 id="naming-conventions">Naming conventions<a class="anchor" aria-label="anchor" href="#naming-conventions"></a>
</h2>
<p>In the sections below, we outline the naming conventions of actions and objects in the package. <strong>Actions</strong> are verbs that describe what a function does, while <strong>objects</strong> are nouns that represent the parameters that the functions operate on.</p>
<section class="level3"><h3 id="actions">Actions<a class="anchor" aria-label="anchor" href="#actions"></a>
</h3>
<table class="table caption-top">
<caption>Actions used in <code>registers2parquet</code>.</caption>
<colgroup>
<col style="width: 26%">
<col style="width: 73%">
</colgroup>
<thead><tr class="header">
<th>Action</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>convert</td>
<td>Convert a register SAS file (or multiple) to Parquet.</td>
</tr>
<tr class="even">
<td>get</td>
<td>Used for internal helper functions to e.g., get or extract the year from a file name.</td>
</tr>
<tr class="odd">
<td>list</td>
<td>List or retrieve an object or multiple objects. E.g., a path, a register name, or a year from a file name.</td>
</tr>
<tr class="even">
<td>read</td>
<td>Read a Parquet register into R as a DuckDB table.</td>
</tr>
</tbody>
</table>
<!-- TODO: Should the registers2parquet function be called something with the action *convert* instead? Or do we like the simplicity of it having be the same name as the package? --></section><section class="level3"><h3 id="objects">Objects<a class="anchor" aria-label="anchor" href="#objects"></a>
</h3>
<table class="table caption-top">
<caption>Objects used in <code>registers2parquet</code>.</caption>
<colgroup>
<col style="width: 26%">
<col style="width: 73%">
</colgroup>
<thead><tr class="header">
<th>Object</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>output_path</code></td>
<td>A character scalar with the absolute path to the directory where the Parquet file should be created in.</td>
</tr>
<tr class="even">
<td><code>path</code></td>
<td>A character vector with the absolute path to a file or directory. It can be a single path or multiple paths as a character vector. Is used in functions to list available files or to specify input files.</td>
</tr>
<tr class="odd">
<td><code>project_id</code></td>
<td>A character scalar with the DST project number to the folder containing the raw or work data.</td>
</tr>
<tr class="even">
<td><code>register_name</code></td>
<td>A character scalar with the name of a register used in the file name (without a path), e.g., “bef”. It’s used in <code>list</code> functions to retrieve the paths of objects including that name.</td>
</tr>
</tbody>
</table></section></section><section class="level2"><h2 id="interface">Interface<a class="anchor" aria-label="anchor" href="#interface"></a>
</h2>
<p><code>registers2parquet</code> includes two main functions and multiple helper functions. Each function is listed below with a short description.</p>
<div>
<blockquote>
<p><strong>Tip</strong></p>
<p>See the <a href="./reference/index.html">Reference documentation</a> for more details.</p>
</blockquote>
</div>
<section class="level3"><h3 id="main-functions">Main functions<a class="anchor" aria-label="anchor" href="#main-functions"></a>
</h3>
<section class="level4"><h4 id="convert_to_parquet">
<code>convert_to_parquet()</code><a class="anchor" aria-label="anchor" href="#convert_to_parquet"></a>
</h4>
<p>This function takes one or more register SAS files and converts them to a Parquet file or a Parquet dataset partitioned by year.</p>
<p>See the <code><a href="../reference/convert_to_parquet.html">convert_to_parquet()</a></code> reference for more details.</p>
<p>The function requires two inputs:</p>
<ul>
<li>
<strong>path</strong>: A character vector with path(s) to one or several files that should be converted.</li>
<li>
<strong>output_path</strong>: A character vector with the path to the directory where the Parquet file(s) should be written to.</li>
</ul>
<p>If multiple files are given, the function looks for a year in the file names to use as partitioning. The function also removes any duplicate rows before saving the data.</p>
<p>The output of <code>convert_register_to_parquet()</code> is the character vector given as input in <code>output_path</code>. This allows for easy integration into a targets pipeline.</p>
<p>Even though the function doesn’t return the written Parquet register, its creation is confirmed with a message in the R console.</p>
<p>The created Parquet files will be stored in a directory structure that reflects the register name and a year partitioning if a year can be determined from the file name(s). Below is shown an example of the input and output for a collection of SAS files for the <code>bef</code> register:</p>
</section><div class="columns">
<div class="column">
<section class="level4"><h4 id="input-register-sas-files">Input: Register SAS files<a class="anchor" aria-label="anchor" href="#input-register-sas-files"></a>
</h4>
<pre><code><span><span class="va">bef2018.sas7bdat</span></span>
<span><span class="va">bef2019.sas7bdat</span></span>
<span><span class="va">bef2020.sas7bdat</span></span>
<span><span class="va">bef2021.sas7bdat</span></span>
<span><span class="va">bef2022.sas7bdat</span></span>
<span><span class="va">December_2023</span><span class="op">/</span><span class="va">bef2022.sas7bdat</span></span>
<span><span class="va">December_2023</span><span class="op">/</span><span class="va">bef2023.sas7bdat</span></span></code></pre>
</section>
</div>
<div class="column">
<section class="level4"><h4 id="output-parquet-files">Output: Parquet files<a class="anchor" aria-label="anchor" href="#output-parquet-files"></a>
</h4>
<pre><code>bef/
├── year=2018/
│   └── part-0.parquet
├── year=2019/
│   └── part-0.parquet
├── year=2020/
│   └── part-0.parquet
├── year=2021/
│   └── part-0.parquet
├── year=2022/
│   └── part-0.parquet
└── year=2023/
    └── part-0.parquet</code></pre>
</section>
</div>
</div>
<p>As shown above, the Parquet files will be stored in a directory named after the register (e.g., <code>bef/</code>), with subdirectories for each year (e.g., <code>year=2018/</code>, <code>year=2019/</code>, etc.) if the year can be determined from the file name. Each year directory contains a Parquet file (<code>part-0.parquet</code>). This structure allows for efficient querying and retrieval of data based on the year.</p>
<section class="level4"><h4 id="read_registerregister_name-project_id">
<code>read_register(register_name, project_id)</code><a class="anchor" aria-label="anchor" href="#read_registerregister_name-project_id"></a>
</h4>
<p>Reads a Parquet register from the specified path and returns it as a DuckDB table.</p>
<p>See the <code><a href="../reference/read_register.html">read_register()</a></code> reference for more details.</p>
</section></section><section class="level3"><h3 id="helper-functions">Helper functions<a class="anchor" aria-label="anchor" href="#helper-functions"></a>
</h3>
<section class="level4"><h4 id="list_sas_registersproject_id">
<code>list_sas_registers(project_id)</code><a class="anchor" aria-label="anchor" href="#list_sas_registersproject_id"></a>
</h4>
<p>Lists all SAS files in a given directory. It returns a character vector of file paths with the <code>.sas7bdat</code> extension at the given directory.</p>
<!-- TODO: Add link to reference documentation when ready -->
</section><section class="level4"><h4 id="list_parquet_registersproject_id">
<code>list_parquet_registers(project_id)</code><a class="anchor" aria-label="anchor" href="#list_parquet_registersproject_id"></a>
</h4>
<p>Lists all Parquet files in a given directory. It returns a character vector of file paths with the <code>.parquet</code> or <code>.parq</code> extension at the given directory.</p>
<!-- TODO: Add link to reference documentation when ready -->
</section></section></section><section class="level2"><h2 id="expected-flow">Expected flow<a class="anchor" aria-label="anchor" href="#expected-flow"></a>
</h2>
<p>We expect the flow of using the <code>registers2parquet</code> package to convert register SAS files to Parquet files will be as follows:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-flow" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-flow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-flow">flowchart TD

    identify_paths("Identify register path(s)&lt;br&gt;with helper functions")
    path[/"path&lt;br&gt;[Character vector]"/]
    output_path[/"output_path&lt;br&gt;[Character scalar]"/]
    convert_to_parquet("convert_to_parquet()")
    output[/"Output&lt;br&gt;[Character scalar]&lt;br&gt;Path to Parquet file(s)"/]


    %% Edges
    identify_paths -.-&gt; path --&gt; convert_to_parquet
    output_path --&gt; convert_to_parquet
    convert_to_parquet --&gt; output

    %% Styling
    style identify_paths fill:#FFFFFF, color:#000000, stroke-dasharray: 5 5
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-flow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 1: Flow of the expected flow using the <code><a href="../reference/convert_to_parquet.html">convert_to_parquet()</a></code> package to convert register SAS files to Parquet files.
</figcaption></figure>
</div>
</div>
</div>
<p>We expect a flow of reading a Parquet register created by the <code>registers2parquet</code> package into an R session to be as follows:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-flow-use" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-flow-use-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-flow-use">flowchart TD

    project_id[/"project_id&lt;br&gt;[Character scalar]"/]
    path[/"path&lt;br&gt;[Character scalar]"/]

    read_register("read_register()")

    output[/"Output&lt;br&gt;[DuckDB table]"/]

    %% Edges
    path &amp; project_id --&gt; read_register --&gt; output

</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-flow-use-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 2: Flow of the expected flow of reading a Parquet register that was created with the <code>registers2parquet</code> package.
</figcaption></figure>
</div>
</div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Luke Johnston, Signe Kirk Brødbæk.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
