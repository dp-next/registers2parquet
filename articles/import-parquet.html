<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Loading the data: Importing the Parquet format using DuckDB • registers2parquet</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="import-parquet_files/libs/quarto-html/popper.min.js"></script><script src="import-parquet_files/libs/quarto-html/tippy.umd.min.js"></script><link href="import-parquet_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="import-parquet_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Loading the data: Importing the Parquet format using DuckDB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">registers2parquet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/design.html">Design</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/dp-next/registers2parquet/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Loading the data: Importing the Parquet format using DuckDB</h1>




      <small class="dont-index">Source: <a href="https://github.com/dp-next/registers2parquet/blob/main/vignettes/import-parquet.qmd" class="external-link"><code>vignettes/import-parquet.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <p>Now that we have the data stored in the Parquet format, we want some way of loading it into R to use it. Here I recommend and show how to use the SQL-variant DuckDB to work with the data. I’ll explain about DuckDB, why I’m suggesting using it, and how to use it.</p>
<section class="level2"><h2 id="what-is-sql-and-duckdb">What is SQL and DuckDB?<a class="anchor" aria-label="anchor" href="#what-is-sql-and-duckdb"></a>
</h2>
<p>I mention SQL briefly in the <code><a href="../articles/saving-as-parquet.html">vignette("saving-as-parquet")</a></code>, but I’ll expand more here. SQL stands for “Structured Query Language” and is a widely used and well established way of working and interacting with databases. There are a couple of potentially terms here that I should clarify what they mean.</p>
<ul>
<li><p>Database: Also called a “relational database”. This specifically refers a file that contains to one or more “tables” of data. A table is a rectangular data object, like what you would see in a spreadsheet (rows and columns). So a database can contain multiple tables of data that are connected. In our case, a database of the registers would have the PNR (unique personal ID) that connects all the tables together.</p></li>
<li><p>Query: To query something means to request something from something else. In the case of querying a database, it means we want to get some data from the database. For instance, if we hypothetically want PNR, income, and diabetes status of those born after 2000, we would query the database tables for the columns PNR, income, and diabetes status of all persons whose birth date was after 2000.</p></li>
<li><p>Structured: In this case, this means that it is a well defined way of querying a database that is the most efficient. Because “structured” is part of SQL, this is not something you as the user have to think about, SQL (mostly) automatically makes the query efficient for you.</p></li>
<li><p>Language: Here this means that SQL is a programming language that you write code to do actions. Thankfully, we R users don’t need to actually know how to write SQL because dplyr converts many of its commands automatically into SQL commands when the dataset we are working on is a SQL database. More on this later.</p></li>
</ul>
<p>Ok, but what is DuckDB? Well, SQL is a generic term for any programming language that interacts with databases. There are dozens of SQL variants out there, with common ones being MySQL, SQLite, or Postgres. However, a main disadvantage of these other variants is that they aren’t designed for data analysis in mind. Many of them are designed with needs that businesses and industry people have, not researchers or data scientists. DuckDB is a variant that is designed specifically with data analysis in mind. Plus, DuckDB can easily interact with our Parquet data files.</p>
</section><section class="level2"><h2 id="why-should-you-use-sqlduckdb">Why should you use SQL/DuckDB?<a class="anchor" aria-label="anchor" href="#why-should-you-use-sqlduckdb"></a>
</h2>
<p>Alright, now that you know what SQL and DuckDB are, why should you use it? Why not load in the data with <code><a href="https://haven.tidyverse.org/reference/read_sas.html" class="external-link">haven::read_sas()</a></code> or (if it is a csv file) with data.table or readr? In our particular case, registers are MASSIVE databases and loading the data into R and thus into memory can take quite a long time. The big advantage of SQL/DuckDB is that it doesn’t load anything into memory and any computation done on the data is done in an efficient, fast, and low-memory way. So we can do a lot of initial data cleaning, wrangling, summarizing, and preparing in DuckDB before finally loading it into memory to do the final statistical analysis with R’s functions. So basically, the reasons are:</p>
<ul>
<li>It doesn’t need to be loaded into R, so you can right away start doing data wrangling for your specific project.</li>
<li>Its super fast to do wrangling, joining, and basic summarizing, so you can quickly get to the more intensive data analysis sooner.</li>
<li>It doesn’t use as much computer resources like memory, so is from a cost and environmental sustainability perspective better.</li>
</ul>
<p><strong>But most importantly</strong>, it is stupid easy to work with DuckDB within R through dplyr (technically dbplyr) and I’ll show you how!</p>
</section><section class="level2"><h2 id="working-with-the-data-while-in-r">Working with the data while in R<a class="anchor" aria-label="anchor" href="#working-with-the-data-while-in-r"></a>
</h2>
<p>The key packages you’ll want to use are the duckdb and arrow packages. So we can load them up. There’s also a custom function within this registers2parquet package that helps with loading the register databases. Everyone on this project folder <em>should theoretically</em> have this package installed, but let me know if you don’t.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dp-next.github.io/registers2parquet/">registers2parquet</a></span><span class="op">)</span></span>
<span><span class="co"># devtools::load_all()</span></span></code></pre></div>
</div>
<p>To see the list of registers available in the Parquet database, use this function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/list_databases.html">list_databases</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Let’s take a simple register as an example. The “ftforael” will do. Use the custom <code>load_database()</code> function from this registers2parquet package. After that, we need assign</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ftf_db</span> <span class="op">&lt;-</span> <span class="fu">load_database</span><span class="op">(</span><span class="st">"ftforael"</span><span class="op">)</span></span>
<span><span class="va">ftf_db</span></span></code></pre></div>
</div>
<p>You’ll see that the printed output of this object says <code># Source: table&lt;arrow_002&gt; [?? x 12]</code>, or something similar. What this means is that it is showing you a small output of an arrow table (the Parquet data format), that it has 12 columns and an unknown number of rows. Why unknown? Because DuckDB doesn’t store anything on memory and because of the way it processes the query to the database, it can’t actually tell you how many rows are in the database unless you specifically ask for it. For us, we don’t really need to know at this point.</p>
<p>What if you want to do some wrangling. You can use almost all dplyr functions and when you end the pipe with <code>compute()</code>, it sends the query to the database to get processed. You don’t have to end with <code>compute()</code>, but its good practice to use it to indicate where in the pipeline you want the query to actually get sent.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ftf_db</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Luke Johnston, Signe Kirk Brødbæk.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
