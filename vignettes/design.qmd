---
title: Design
vignette: >
  %\VignetteIndexEntry{Design}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

## Conversion process

::::: columns
::: column
```         
bef2018.sas7bdat
bef2019.sas7bdat
bef2020.sas7bdat
bef2021.sas7bdat
bef2022.sas7bdat
December_2023/bef2022.sas7bdat
December_2023/bef2023.sas7bdat
```
:::

::: column
```         
bef/
├── year=2018/
│   └── part-0.parquet
├── year=2019/
│   └── part-0.parquet
├── year=2020/
│   └── part-0.parquet
├── year=2021/
│   └── part-0.parquet
├── year=2022/
│   └── part-0.parquet
└── year=2023/
    └── part-0.parquet
```
:::
:::::

## Parallel processing

Each register-year pairing (including duplicate years) are sent to a
separate process. That way, rather than converting 1000+ registers one
after the other, it can be split into chunks based on the number of
available CPU cores. For instance, if you set the number of "workers"
(cores) to 4, than the 1000+ registers will be split into 4 groups and
each group will be processed simultaneously on its own core.

There are some overheads to parallel processing, so it works best with a
large number of files and when the files are also relatively large, or
if the processing time per file is substantial.

## Visual representation of data flow

```{mermaid}
%%| fig-alt: "A flowchart showing the data flow within `registers2parquet`, showing how SAS files are imported, potentially joined, and then exported as Parquet files with a year partitioning."
%%| file: flow.mmd
```

## Functions

There is one main function and several helper functions that we expose
in this package. Each function is listed below with a short description.

### Main function: `convert_register_to_parquet()`

This is the main function of the package. It takes as input one or more
SAS files, reads them, merges them if necessary, and saves them as a
Parquet file. If multiple files are given, the function looks for a year
in the file names to use as partitioning. The function also removes any
duplicate rows before saving the data. The output is the path to the
created Parquet file(s) as specified by the `output_path` parameter.

<!-- TODO: Add link to reference documentation when ready -->


### Helper functions

<!-- TODO: Do we want to include the helper functions for duplicate and non-duplicate paths? -->

#### `list_files_with_year(path)`

Lists all files in a given directory that contain a year (four
consecutive digits) in their filenames. It returns a character vector of
file paths that match this criterion.

<!-- TODO: Add link to reference documentation when ready -->

#### `list_files_without_year(path)`

Lists all files in a given directory that **do not** contain a year
(four consecutive digits) in their filenames. It returns a character
vector of file paths that match this criterion.

<!-- TODO: Add link to reference documentation when ready -->

#### `list_register_files(path, register_name)`

Lists all files (independently of file format) in a given directory that
match a specific register name. It returns a character vector of file
paths that match the specified register.

<!-- TODO: Add link to reference documentation when ready -->

#### `list_sas_files(path)`

Lists all SAS files in a given directory. It returns a character vector
of file paths with the `.sas7bdat` extension at the given directory.

<!-- TODO: Add link to reference documentation when ready -->

#### `list_parquet_files(path)`

Lists all Parquet files in a given directory. It returns a character
vector of file paths with the `.parquet` or `.parq` extension at the
given directory.

<!-- TODO: Add link to reference documentation when ready -->

#### `list_dirs(path)`

Lists all directories in a given directory. It returns a character
vector of paths (subdirectories and files) at the given directory.

<!-- TODO: Add link to reference documentation when ready -->

#### `read_register_parquet(path)`

Reads a Parquet register from the specified path and returns it as a
DuckDB table.

<!-- TODO: Add link to reference documentation when ready -->