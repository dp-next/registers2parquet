---
title: Design
vignette: >
  %\VignetteIndexEntry{Design}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

## Conversion process

::::: columns
::: column
```
bef2018.sas7bdat
bef2019.sas7bdat
bef2020.sas7bdat
bef2021.sas7bdat
bef2022.sas7bdat
December_2023/bef2022.sas7bdat
December_2023/bef2023.sas7bdat
```
:::

::: column
```
bef/
├── year=2018/
│   └── part-0.parquet
├── year=2019/
│   └── part-0.parquet
├── year=2020/
│   └── part-0.parquet
├── year=2021/
│   └── part-0.parquet
├── year=2022/
│   └── part-0.parquet
└── year=2023/
    └── part-0.parquet
```
:::
:::::

## Parallel processing

Each register-year pairing (including duplicate years) are sent to a
separate process. That way, rather than converting 1000+ registers one
after the other, it can be split into chunks based on the number of
available CPU cores. For instance, if you set the number of "workers"
(cores) to 4, than the 1000+ registers will be split into 4 groups and
each group will be processed simultaneously on its own core.

There are some overheads to parallel processing, so it works best with a
large number of files and when the files are also relatively large, or
if the processing time per file is substantial.

## Visual representation of data flow

```{mermaid}
%%| fig-alt: "A flowchart showing the data flow within `registers2parquet`, showing how SAS files are imported, potentially joined, and then exported as Parquet files with a year partitioning."
%%| file: flow.mmd
```

## Expected flow

We expect the flow of using the `registers2parquet` package to convert
register SAS files to Parquet files will be as follows:

```{mermaid}
%%| label: fig-flow
%%| fig-cap: "Flow of the expected flow using the `convert_to_parquet()` package to convert register SAS files to Parquet files."
%%| fig-alt: "A flowchart showing the expected flow of converting register SAS files to Parquet files using the `registers2parquet` package. It includes identifying paths to the relevant SAS files using the helper functions, calling the main function `convert_to_parquet()`, which then outputs the path to the written Parquet files."
flowchart TD

    identify_paths("Identify register path(s)<br>with helper functions")
    path[/"path<br>[Character vector]"/]
    output_path[/"output_path<br>[Character vector]"/]
    convert_to_parquet("convert_to_parquet()")
    output[/"Output<br>[Character vector]<br>Path to Parquet file(s)"/]


    %% Edges
    identify_paths -.-> path --> convert_to_parquet
    output_path --> convert_to_parquet
    convert_to_parquet --> output

    %% Styling
    style identify_paths fill:#FFFFFF, color:#000000, stroke-dasharray: 5 5
```

We expect a flow of reading a Parquet register created by the
`registers2parquet` package into an R session to be as follows:

```{mermaid}
%%| label: fig-flow-use
%%| fig-cap: "Flow of the expected flow of reading a Parquet register that was created with the `registers2parquet` package."
%%| fig-alt: "A flowchart showing the expected flow of reading a Parquet register created with the `registers2parquet` package. It includes using the register name to read a specific register into the R session using the `read_register_parquet()` function, which outputs the register as a DuckDB table."
flowchart TD

    project_id[/"project_id<br>[Character scalar]"/]
    path[/"path<br>[Character scalar]"/]

    read_register("read_register()")

    output[/"Output<br>[DuckDB table]"/]

    %% Edges
    path & project_id --> read_register --> output

```
